## 重构目标
- 清晰边界：严格区分 `server` / `client` / `shared` / `infra`，消除混搭与潜在打包问题。
- 垂直切片：按领域拆分（`auth`、`prefs`、`telemetry`），每个切片内部再分 `server|client|shared`，提升内聚、降低耦合。
- 稳定入口：统一 API 入口、中间件管线、会话/鉴权、离线同步与前端装配的导入路径。

## 目录与别名
- 保留：`@src/*`
- 分层：`@server/*`、`@client/*`、`@shared/*`、`@infra/*`、`@features/*`
- 约束：使用 ESLint `no-restricted-imports` 强制 `client` 不引用 `server|infra`，`shared` 仅持类型与纯函数。

## 结构调整
- `infra`（基础设施实现）
  - `infra/db/{mysql,redis}.ts`（现有连接从 `server/db` 迁移）
  - `infra/security/{csrf,rateLimit,config}.ts`（安全策略与工具）
  - `infra/log.ts`（如有单例日志）
- `features/auth`
  - `server`: `auth/guard.ts`、`api/session.ts`、`session/kv.ts`、相关中间件；`config/session.ts`（常量可部分迁入 `shared`）
  - `shared`: 角色/会话类型与常量（仅类型与纯函数）
  - `client`: 仅可能的登录态状态片（若存在）
- `features/prefs`
  - `server`: `prefs/server.ts` 与 `/api/prefs` 路由处理
  - `shared`: DTO/类型
  - `client`: `PrefsLoader`、存储/查询
- `features/telemetry`
  - `server`: `services/TelemetryService.ts`、`repos/mysql/TelemetryRepo.ts`、`/api/telemetry/*`
  - `client`: `observability/client.ts`
  - `shared`: 事件/日志类型
- `server/middleware`
  - `compose.ts`、`logging.ts`、`securityHeaders.ts`、`api.ts`、`admin.ts`
- `client`
  - `providers/AppProviders.tsx`、`state/*`、`storage/indexeddb.ts`、`sync/*`、`net/apiClient.ts`
- `shared`
  - `types/*` 与纯工具函数

## 迁移清单（阶段化）
1. 切出 `infra`
   - 移动 `server/db/*` → `infra/db/*`；`server` 引用改为 `@infra/db/*`
   - 移动 `core/security/*` → `infra/security/*`；`server`/`features` 引用改为 `@infra/security/*`
2. 完成 `features/auth`
   - 移动：`server/auth/guard.ts`、`server/api/session.ts`、`server/session/kv.ts`、`core/config/session.ts`
   - 拆分常量到 `features/auth/shared`（如 `SESSION_COOKIE_NAME`）；`TTL` 可保留在 `server`
   - 更新所有路由/中间件对别名的引用
3. 完成 `features/telemetry`
   - 移动：`server/services/TelemetryService.ts`、`server/repos/mysql/TelemetryRepo.ts`、客户端 `observability/client.ts`
   - 统一 `/api/telemetry/*` 的导入路径与中间件装配
4. 完成 `features/prefs`
   - 移动：`server/prefs/server.ts`、客户端 `providers/PrefsLoader.tsx` 相关引用
   - 统一 `/api/prefs` 处理位置与类型
5. 清理旧 `src/core`
   - 逐步移除 `core` 中的转发文件；直接在业务处改用新别名
   - 保留少量兼容导出直至页面与路由全部迁移完成

## API 与中间件统一
- 维持 `withApi(req, extra, handler)` 作为标准入口，位于 `@server/middleware/api`
- 管线默认包含 `logging` 与 `securityHeaders`，可按路由叠加 `requireAdmin`

## 验证与回归
- 每阶段：
  - 运行类型检查与构建，确保 0 错误与路由正常；必要时跑本地预览检查 `/api/*` 与 `/dev` 页面
  - 对会话相关路径进行冒烟测试：登录态解析、TTL 续期、CSRF 校验
  - 对离线队列与同步：强制离线，验证 `outbox` 入队与回放
  - 对观测：请求日志写入与事件上报入库

## 风险控制
- 保留 re-export 兼容层，减少一次性爆改风险；每次迁移后立即修正导入并验证
- 严守 `client` 不引用 `next/server|headers|db`、`infra` 的规则
- 所有新增/移动文件维持原行为与签名，不改逻辑，仅改路径

## 交付
- 完整分层与切片后的目录结构与别名
- 所有页面与 API 路由导入已更新，无核心 `core` 依赖
- 类型检查、Lint、构建通过；关键路径冒烟验证完成